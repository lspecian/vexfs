# VexFS v2.0 + Ollama Integration Test Makefile
#
# This Makefile builds the end-to-end integration test that combines
# Ollama-generated real embeddings with VexFS v2.0 kernel module storage.

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -O2 -g
LDFLAGS = -lm -lcurl -ljson-c

# Directories
OLLAMA_DIR = ollama_integration
KERNEL_DIR = kernel/vexfs_v2_build
INCLUDE_DIRS = -I$(OLLAMA_DIR) -I$(KERNEL_DIR) -I.

# Source files
INTEGRATION_SRC = ollama_vexfs_integration_test.c
OLLAMA_LIB = $(OLLAMA_DIR)/libvexfs_ollama.a

# Output binary
INTEGRATION_BIN = ollama_vexfs_integration_test

# Default target
all: $(INTEGRATION_BIN)

# Build integration test
$(INTEGRATION_BIN): $(INTEGRATION_SRC) $(OLLAMA_LIB)
	@echo "🔧 Building VexFS v2.0 + Ollama Integration Test..."
	$(CC) $(CFLAGS) $(INCLUDE_DIRS) -o $@ $< $(OLLAMA_LIB) $(LDFLAGS)
	@echo "✅ Integration test built successfully: $@"

# Check dependencies
check-deps:
	@echo "🔍 Checking dependencies..."
	@if [ ! -f "$(OLLAMA_LIB)" ]; then \
		echo "❌ Ollama library not found: $(OLLAMA_LIB)"; \
		echo "   Please build it first with: make -C $(OLLAMA_DIR)"; \
		exit 1; \
	fi
	@if [ ! -f "$(KERNEL_DIR)/vexfs_v2_uapi.h" ]; then \
		echo "❌ VexFS v2.0 UAPI header not found: $(KERNEL_DIR)/vexfs_v2_uapi.h"; \
		exit 1; \
	fi
	@echo "✅ All dependencies found"

# Clean build artifacts
clean:
	rm -f $(INTEGRATION_BIN)
	@echo "🧹 Cleaned integration test artifacts"

# Install test (copy to system location)
install: $(INTEGRATION_BIN)
	sudo cp $(INTEGRATION_BIN) /usr/local/bin/
	@echo "📦 Integration test installed to /usr/local/bin/"

# Uninstall test
uninstall:
	sudo rm -f /usr/local/bin/$(INTEGRATION_BIN)
	@echo "🗑️  Integration test uninstalled"

# Run the integration test
test: $(INTEGRATION_BIN)
	@echo "🚀 Running VexFS v2.0 + Ollama Integration Test..."
	@echo "Prerequisites:"
	@echo "  - VexFS v2.0 kernel module loaded"
	@echo "  - VexFS mounted at /tmp/vexfs_test"
	@echo "  - Ollama service running with embedding models"
	@echo ""
	./$(INTEGRATION_BIN)

# Quick test with basic validation
quick-test: $(INTEGRATION_BIN)
	@echo "⚡ Running quick integration validation..."
	timeout 60 ./$(INTEGRATION_BIN) || echo "Test completed or timed out"

# Help target
help:
	@echo "VexFS v2.0 + Ollama Integration Test Makefile"
	@echo "=============================================="
	@echo ""
	@echo "Targets:"
	@echo "  all         - Build integration test (default)"
	@echo "  check-deps  - Check if dependencies are available"
	@echo "  clean       - Clean build artifacts"
	@echo "  install     - Install test to system location"
	@echo "  uninstall   - Remove test from system"
	@echo "  test        - Run the integration test"
	@echo "  quick-test  - Run quick validation test"
	@echo "  help        - Show this help message"
	@echo ""
	@echo "Prerequisites:"
	@echo "  - VexFS v2.0 kernel module built and loaded"
	@echo "  - Ollama integration library built"
	@echo "  - VexFS mounted at /tmp/vexfs_test"
	@echo "  - Ollama service running with models"

.PHONY: all check-deps clean install uninstall test quick-test help