# Preseed file for Debian 12 (Bookworm)
# Sets up a minimal installation with root login via password.

# Localization
d-i debian-installer/locale string en_US
d-i console-setup/ask_detect boolean false
d-i keyboard-configuration/xkb-keymap select us

# Network configuration
d-i netcfg/get_hostname string vexfs-vm
d-i netcfg/get_domain string localdomain
# If your network doesn't have DHCP, you'll need to configure static networking here.
# For DHCP (most common):
d-i netcfg/dhcp_options select Register hostname with DHCP server
d-i netcfg/dhcp_timeout string 60

# Mirror settings
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

# Account setup
# Create a root account with a password.
# For security, this password should be changed or SSH keys used post-installation.
# The password "password" is insecure and only for this automated setup.
d-i passwd/root-password password password
d-i passwd/root-password-again password password
# Optionally, create a regular user account
# d-i passwd/user-fullname string Packer User
# d-i passwd/username string packer
# d-i passwd/user-password password packerpass
# d-i passwd/user-password-again password packerpass
# d-i user-setup/allow-password-weak boolean true

# Clock and time zone setup
d-i clock-setup/utc boolean true
d-i time/zone string UTC
d-i clock-setup/ntp boolean true

# Partitioning
# Use guided partitioning for the entire disk.
# This will erase the disk.
d-i partman-auto/method string regular
d-i partman-auto/choose_recipe select atomic
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true
# You might want to choose a specific partitioning scheme, e.g., separate /home.
# For a simple VM, a single partition for / is often fine.
d-i partman-auto/disk string /dev/sda # Or whatever your disk is named by the installer
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true


# Package selection
# Install the standard system utilities and an SSH server.
tasksel tasksel/first multiselect standard, ssh-server
# You can choose not to install a desktop environment for a server/test VM.
# To install minimal system without graphical interface:
# tasksel tasksel/first multiselect standard
# Ensure "standard system utilities" is selected if you choose minimal.
# d-i pkgsel/include string openssh-server build-essential

# GRUB boot loader installation
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
# Install GRUB to the master boot record.
d-i grub-installer/bootdev string /dev/sda # Default, adjust if needed

# Finishing up the installation
d-i finish-install/reboot_in_progress note
d-i cdrom-detect/eject boolean true

# Advanced options
# Uncomment if you want to enable non-free and contrib repositories
# d-i apt-setup/non-free boolean true
# d-i apt-setup/contrib boolean true

# Prevent prompts for selecting services to restart
d-i debconf/frontend select Noninteractive
d-i debconf/priority select critical

# This is useful for debugging preseed issues
# d-i log_level string debug

# Other settings
d-i preseed/late_command string \
    in-target apt-get update; \
    in-target apt-get install -y sudo; \
    in-target sed -i '/^%sudo/ s/ALL$/NOPASSWD:ALL/' /etc/sudoers; \
    echo 'Preseed late_command executed successfully' > /target/root/preseed_late_command.log
    # The user 'packer' if created, would need to be added to sudo group:
    # in-target /usr/sbin/usermod -aG sudo packer; \
    # This setup uses root directly via SSH for Packer provisioners to simplify.
    # Ensure ssh_username in Packer matches (root).
    # If you create a non-root user and want to SSH as them, ensure they are in sudoers.
    # For root login via SSH (often disabled by default on servers):
    # in-target sed -i 's/^#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config; \
    # in-target sed -i 's/^PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config; \
    # The default Debian 12 netinst seems to allow root SSH with password if set during install.
    # The `ssh_username = "root"` and `ssh_password = "password"` in packer should work.
