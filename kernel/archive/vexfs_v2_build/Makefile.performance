# VexFS v2.0 Performance Validation Framework Makefile
# 
# This Makefile builds the comprehensive performance testing suite
# for VexFS v2.0 vector operations.

CC = gcc
CFLAGS = -Wall -Wextra -O2 -std=c99 -D_GNU_SOURCE
LDFLAGS = -lm -lrt

# Source files
PERFORMANCE_SRC = vexfs_v2_performance_validator.c
UAPI_HEADER = vexfs_v2_uapi.h

# Target binaries
PERFORMANCE_BIN = vexfs_v2_performance_validator
EXISTING_TESTS = final_corrected_vector_test test_with_uapi_header

# Default target
all: $(PERFORMANCE_BIN) $(EXISTING_TESTS)

# Performance validation framework
$(PERFORMANCE_BIN): $(PERFORMANCE_SRC) $(UAPI_HEADER)
	@echo "üîß Building VexFS v2.0 Performance Validation Framework..."
	$(CC) $(CFLAGS) -o $@ $(PERFORMANCE_SRC) $(LDFLAGS)
	@echo "‚úÖ Performance validator built successfully: $@"

# Existing test programs
final_corrected_vector_test: final_corrected_vector_test.c $(UAPI_HEADER)
	@echo "üîß Building final corrected vector test..."
	$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
	@echo "‚úÖ Final corrected test built: $@"

test_with_uapi_header: test_with_uapi_header.c $(UAPI_HEADER)
	@echo "üîß Building UAPI header test..."
	$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
	@echo "‚úÖ UAPI header test built: $@"

# Quick performance test (subset of full validation)
quick-test: $(PERFORMANCE_BIN)
	@echo "üöÄ Running quick performance validation..."
	@echo "‚ö†Ô∏è  Make sure VexFS v2.0 is mounted at /tmp/vexfs_test/"
	@echo "‚ö†Ô∏è  Make sure /tmp/vexfs_test/vector_test_file exists"
	@echo ""
	sudo ./$(PERFORMANCE_BIN) || echo "‚ùå Quick test failed - check VexFS mount status"

# Full performance validation
full-test: $(PERFORMANCE_BIN)
	@echo "üöÄ Running comprehensive performance validation..."
	@echo "‚ö†Ô∏è  This test will take several minutes to complete"
	@echo "‚ö†Ô∏è  Make sure VexFS v2.0 is mounted at /tmp/vexfs_test/"
	@echo "‚ö†Ô∏è  Make sure /tmp/vexfs_test/vector_test_file exists"
	@echo ""
	sudo ./$(PERFORMANCE_BIN) 2>&1 | tee performance_results_$(shell date +%Y%m%d_%H%M%S).log

# Test existing corrected programs
test-existing: $(EXISTING_TESTS)
	@echo "üß™ Testing existing corrected vector programs..."
	@echo ""
	@echo "üîç Running final corrected vector test..."
	sudo ./final_corrected_vector_test || echo "‚ùå Final corrected test failed"
	@echo ""
	@echo "üîç Running UAPI header test..."
	sudo ./test_with_uapi_header || echo "‚ùå UAPI header test failed"

# Setup test environment
setup-test-env:
	@echo "üîß Setting up VexFS v2.0 test environment..."
	@echo "üìÅ Creating test directories..."
	sudo mkdir -p /tmp/vexfs_test
	@echo "üìÑ Creating test file..."
	sudo touch /tmp/vexfs_test/vector_test_file
	sudo chmod 666 /tmp/vexfs_test/vector_test_file
	@echo "‚úÖ Test environment setup complete"
	@echo ""
	@echo "üí° Next steps:"
	@echo "   1. Make sure VexFS v2.0 kernel module is loaded"
	@echo "   2. Mount VexFS at /tmp/vexfs_test/"
	@echo "   3. Run 'make test-existing' to verify basic functionality"
	@echo "   4. Run 'make quick-test' for basic performance validation"
	@echo "   5. Run 'make full-test' for comprehensive performance analysis"

# Check kernel module status
check-module:
	@echo "üîç Checking VexFS v2.0 kernel module status..."
	@lsmod | grep vexfs || echo "‚ùå VexFS module not loaded"
	@echo ""
	@echo "üìä Checking mount status..."
	@mount | grep vexfs || echo "‚ùå VexFS not mounted"
	@echo ""
	@echo "üìÅ Checking test file..."
	@ls -la /tmp/vexfs_test/vector_test_file 2>/dev/null || echo "‚ùå Test file not found"

# Clean build artifacts
clean:
	@echo "üßπ Cleaning build artifacts..."
	rm -f $(PERFORMANCE_BIN) $(EXISTING_TESTS)
	rm -f *.o *.log
	@echo "‚úÖ Clean complete"

# Install performance tools (optional)
install: $(PERFORMANCE_BIN)
	@echo "üì¶ Installing VexFS v2.0 performance tools..."
	sudo cp $(PERFORMANCE_BIN) /usr/local/bin/
	sudo cp $(UAPI_HEADER) /usr/local/include/
	@echo "‚úÖ Installation complete"
	@echo "üí° You can now run 'vexfs_v2_performance_validator' from anywhere"

# Uninstall performance tools
uninstall:
	@echo "üóëÔ∏è  Uninstalling VexFS v2.0 performance tools..."
	sudo rm -f /usr/local/bin/$(PERFORMANCE_BIN)
	sudo rm -f /usr/local/include/$(UAPI_HEADER)
	@echo "‚úÖ Uninstallation complete"

# Help target
help:
	@echo "VexFS v2.0 Performance Validation Framework"
	@echo "==========================================="
	@echo ""
	@echo "Available targets:"
	@echo "  all              - Build all test programs"
	@echo "  setup-test-env   - Setup test environment"
	@echo "  check-module     - Check kernel module and mount status"
	@echo "  test-existing    - Run existing corrected test programs"
	@echo "  quick-test       - Run quick performance validation"
	@echo "  full-test        - Run comprehensive performance analysis"
	@echo "  clean            - Clean build artifacts"
	@echo "  install          - Install tools system-wide"
	@echo "  uninstall        - Remove installed tools"
	@echo "  help             - Show this help message"
	@echo ""
	@echo "Prerequisites:"
	@echo "  - VexFS v2.0 kernel module loaded"
	@echo "  - VexFS mounted at /tmp/vexfs_test/"
	@echo "  - Test file at /tmp/vexfs_test/vector_test_file"
	@echo ""
	@echo "Quick start:"
	@echo "  make setup-test-env"
	@echo "  make check-module"
	@echo "  make test-existing"
	@echo "  make quick-test"

.PHONY: all quick-test full-test test-existing setup-test-env check-module clean install uninstall help